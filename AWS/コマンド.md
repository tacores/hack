# コマンド

## AWS CLI install

https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html

## IAM

```shell
# whoami と同じ
aws sts get-caller-identity
{
    "UserId": "q5dh1mdxdf3w0y17jdap",
    "Account": "123456789012",
    "Arn": "arn:aws:iam::123456789012:user/sir.carrotbane"
}
```

```sh
# ユーザーを列挙
aws iam list-users
{
    "Users": [
        {
            "Path": "/",
            "UserName": "sir.carrotbane",
            "UserId": "q5dh1mdxdf3w0y17jdap",
            "Arn": "arn:aws:iam::123456789012:user/sir.carrotbane",
            "CreateDate": "2025-12-24T00:53:29.601570+00:00"
        }
    ]
}
```

```sh
# ユーザーに直接埋め込まれたインラインポリシー（そのユーザー専用）
aws iam list-user-policies --user-name sir.carrotbane
{
    "PolicyNames": [
        "SirCarrotbanePolicy"
    ]
}
```

```sh
# ユーザーにアタッチした管理ポリシー
aws iam list-attached-user-policies --user-name sir.carrotbane
{
    "AttachedPolicies": []
}
```

```sh
# ユーザーが属しているグループ
aws iam list-groups-for-user --user-name sir.carrotbane
{
    "Groups": []
}
```

```sh
# ポリシーが付与する権限を確認
aws iam get-user-policy --policy-name SirCarrotbanePolicy --user-name sir.carrotbane
{
    "UserName": "sir.carrotbane",
    "PolicyName": "SirCarrotbanePolicy",
    "PolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Action": [
                    "iam:ListUsers",
                    "iam:ListGroups",
                    "iam:ListRoles",
                    "iam:ListAttachedUserPolicies",
                    "iam:ListAttachedGroupPolicies",
                    "iam:ListAttachedRolePolicies",
                    "iam:GetUserPolicy",
                    "iam:GetGroupPolicy",
                    "iam:GetRolePolicy",
                    "iam:GetUser",
                    "iam:GetGroup",
                    "iam:GetRole",
                    "iam:ListGroupsForUser",
                    "iam:ListUserPolicies",
                    "iam:ListGroupPolicies",
                    "iam:ListRolePolicies",
                    "sts:AssumeRole"
                ],
                "Effect": "Allow",
                "Resource": "*",
                "Sid": "ListIAMEntities"
            }
        ]
    }
}
```

```sh
# アカウント内の既存ロールを一覧表示
aws iam list-roles
{
    "Roles": [
        {
            "Path": "/",
            "RoleName": "bucketmaster",
            "RoleId": "AROARZPUZDIKAOMSQZGIX",
            "Arn": "arn:aws:iam::123456789012:role/bucketmaster",
            "CreateDate": "2025-12-24T00:53:29.731354+00:00",
            "AssumeRolePolicyDocument": {
                "Statement": [
                    {
                        "Action": "sts:AssumeRole",
                        "Effect": "Allow",
                        "Principal": {
                            "AWS": "arn:aws:iam::123456789012:user/sir.carrotbane"
                        }
                    }
                ],
                "Version": "2012-10-17"
            },
            "MaxSessionDuration": 3600
        }
    ]
}
```

```sh
# ロールのインラインポリシー
aws iam list-role-policies --role-name bucketmaster
{
    "PolicyNames": [
        "BucketMasterPolicy"
    ]
}
```

```sh
# ロールに割り当てられているポリシー
aws iam list-attached-role-policies --role-name bucketmaster
{
    "AttachedPolicies": []
}
```

```sh
# ポリシーの権限
aws iam get-role-policy --role-name bucketmaster --policy-name BucketMasterPolicy
{
    "RoleName": "bucketmaster",
    "PolicyName": "BucketMasterPolicy",
    "PolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Action": [
                    "s3:ListAllMyBuckets"
                ],
                "Effect": "Allow",
                "Resource": "*",
                "Sid": "ListAllBuckets"
            },
            {
                "Action": [
                    "s3:ListBucket"
                ],
                "Effect": "Allow",
                "Resource": [
                    "arn:aws:s3:::easter-secrets-123145",
                    "arn:aws:s3:::bunny-website-645341"
                ],
                "Sid": "ListBuckets"
            },
...
```

```sh
# ロールを引き受ける
aws sts assume-role --role-arn arn:aws:iam::123456789012:role/bucketmaster --role-session-name TBFC
{
    "Credentials": {
        "AccessKeyId": "ASIARZPUZDIKK5W4WS52",
        "SecretAccessKey": "......................",
        "SessionToken": ".........................",
        "Expiration": "2025-12-24T02:14:58.856230+00:00"
    },
    "AssumedRoleUser": {
        "AssumedRoleId": "AROARZPUZDIKAOMSQZGIX:TBFC",
        "Arn": "arn:aws:sts::123456789012:assumed-role/bucketmaster/TBFC"
    },
    "PackedPolicySize": 6
}
```

```sh
# 資格情報を設定
export AWS_ACCESS_KEY_ID="ASIAxxxxxxxxxxxx"
export AWS_SECRET_ACCESS_KEY="abcd1234xxxxxxxxxxxx"
export AWS_SESSION_TOKEN="FwoGZXIvYXdzEJr..."

# 確認
aws sts get-caller-identity
{
    "UserId": "AROARZPUZDIKAOMSQZGIX:TBFC",
    "Account": "123456789012",
    "Arn": "arn:aws:sts::123456789012:assumed-role/bucketmaster/TBFC"
}
```

```shell
aws iam create-user --user-name padawan

aws iam add-user-to-group --user-name padawan --group-name padawans

aws iam list-groups-for-user --user-name padawan
```

```shell
aws iam create-access-key --user-name padawan

export AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
export AWS_ACCESS_KEY_ID=AKIAZOEXAMPLE
```

```shell
aws sts assume-role --role-arn arn:aws:iam::Account-ID-From-TASK4:role/jedi --role-session-name Ahsoka

export AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxx
export AWS_ACCESS_KEY_ID=ASIAZOHYLBQBDEXAMPLE
export AWS_SESSION_TOKEN=XXXXXXXXXXXXXXXXXXXXXXXXXXX
```

```shell
# アカウント内の全てのENIを一覧表示
aws ec2 describe-network-interfaces
```

## S3

```sh
aws s3api list-buckets
{
    "Buckets": [
        {
            "Name": "easter-secrets-123145",
            "CreationDate": "2025-12-24T00:53:29+00:00"
        },
        {
            "Name": "bunny-website-645341",
            "CreationDate": "2025-12-24T00:53:29+00:00"
        }
    ],
    "Owner": {
        "DisplayName": "webfile",
        "ID": "bcaf1ffd86f41161ca5fb16fd081034f"
    },
    "Prefix": null
}
```

```sh
aws s3api list-objects --bucket easter-secrets-123145
{
    "Contents": [
        {
            "Key": "cloud_password.txt",
            "LastModified": "2025-12-24T00:53:30+00:00",
            "ETag": "\"c63e1474bf79a91ef95a1e6c8305a304\"",
            "Size": 29,
            "StorageClass": "STANDARD",
            "Owner": {
                "DisplayName": "webfile",
                "ID": "75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a"
            }
        },
        {
            "Key": "groceries.txt",
            "LastModified": "2025-12-24T00:53:30+00:00",
            "ETag": "\"44a93e970be00ed62b8742f42c8600d8\"",
            "Size": 28,
            "StorageClass": "STANDARD",
            "Owner": {
                "DisplayName": "webfile",
                "ID": "75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a"
            }
        }
    ],
    "RequestCharged": null,
    "Prefix": null
}
```

```sh
aws s3api get-object --bucket easter-secrets-123145 --key cloud_password.txt cloud_password.txt
{
    "AcceptRanges": "bytes",
    "LastModified": "2025-12-24T00:53:30+00:00",
    "ContentLength": 29,
    "ETag": "\"c63e1474bf79a91ef95a1e6c8305a304\"",
    "ContentType": "application/octet-stream",
    "Metadata": {}
}
```

## シェル

```sh
# 関数にアタッチされているポリシーの取得
FUNCTIONS="list-images download-images"

for f in $FUNCTIONS ; do
    ROLE=`aws lambda get-function --function-name $f --query Configuration.Role --output text | awk -F\/ '{print $NF}'`
    echo "$f has $ROLE with these managed policies:"
    aws iam list-attached-role-policies --role-name $ROLE
    for p in `aws iam list-role-policies  --role-name $ROLE --query PolicyNames --output text` ; do
        echo "$ROLE for $f has inline policy $p:"
        aws iam get-role-policy --role-name $ROLE --policy-name $p
    done
done
```

```sh
# コードバンドルを取得
FUNCTIONS="list-images download-images"
for f in $FUNCTIONS ; do
    URL=`aws lambda get-function --function-name $f --query Code.Location --output text`
    curl -s $URL -o $f.zip
    mkdir $f
    unzip $f.zip -d $f
done
```
