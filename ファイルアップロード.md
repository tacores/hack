# ファイルアップロード

## 偽装

### 方法論

- 最初は普通にアップロードできるファイルで動作を確認する（リクエスト、レスポンス、アップロード先、参照方法など）
- 次に、リクエストの MIME-TYPE を text/x-php 等に変更してみる。アップロードできない場合、MIME-TYPE によるフィルターが存在することが分かる
- でたらめな拡張子でアップロードできる場合、制限があるとすればブラックリストである可能性が高い

### 拡張子偽装

https://book.hacktricks.xyz/pentesting-web/file-upload#file-upload-general-methodology

PHP として認識される可能性のある拡張子は多数ある。  
拡張子を変更することで、アップロードが通るようになったり、Apache で PHP として実行されるようになる可能性があるので試す価値がある。

```text
.php, .php2, .php3, .php4, .php5, .php6, .php7, .phps, .pht, .phtm, .phtml, .pgif, .shtml, .htaccess, .phar, .inc, .hphp, .ctp, .module
```

### マジックナンバー偽装

https://en.wikipedia.org/wiki/List_of_file_signatures

例えば PHP を GIF ファイルに偽装する場合、
テキストエディターで先頭に適当に 6 バイト追加し、hexeditor で `47 49 46 38 37 61 (GIF87a)` に変更すると、file コマンドなどで GIF ファイルと認識されるようになる。

### 保存先ディレクトリ

/uploads はPHPが実行されない（テキストファイルとしてダウンロードされる）が、/ 直下のPHPは実行される設定もある。  
下記は、../ がフィルターで削除される場合の例。

```http
Content-Disposition: form-data; name="image"; filename="%2e%2e%2e%2e%2f%2fpentest4.jpg.php"
Content-Type: application/x-php
```
