# ファイルシステム

## MBR と GPT

https://tryhackme.com/room/mbrandgptanalysis

### MBR

BIOS ファームウェアが採用するスキーム。  
ディスクの一番最初のセクターで 512 バイトを占有する。  
最近のシステムは UEFI ファームウェアが採用する GPT に置き換えられている。

#### 1. 0-445 ブートローダーコード

- 初期ブートローダが含まれる。
- 初期ブートローダの目的は、パーティションテーブルからブート可能パーティションを見つけること。
- ブート可能パーティションから二番目のブートローダーをロードする。
- 二番目のブートローダーは OS のカーネルをロードする。

#### 2. 446-509 パーティションテーブル

| バイト位置 | バイト長 | バイト値の例 | フィールド名         | 説明                                                                           |
| ---------- | -------- | ------------ | -------------------- | ------------------------------------------------------------------------------ |
| 0          | 1        | 80           | ブートインジケーター | 80 はブート可能、00 は不可能。                                                 |
| 1 - 3      | 3        | 20 21 00     | 開始 CHS アドレス    | パーティションの物理開始アドレス。シリンダ番号、ヘッド番号、セクタ番号で構成。 |
| 4          | 1        | 07           | パーティションタイプ | 07 は NTFS                                                                     |
| 5 - 7      | 3        | FE FF FF     | CHS アドレスの終了   |                                                                                |
| 8 - 11     | 4        | 00 08 00 00  | 開始 LBA アドレス    | 論理アドレスなので CHS より使いやすい                                          |
| 12 - 15    | 4        | 00 B0 23 03  | セクター数           | 通常、512 バイトを掛けたらパーティションサイズ。                               |

- CHS = シリンダーヘッドセクター
  MBR_GPT_cheatsheet.pdf
- LBA = 論理ブロックアドレス
- パーティションタイプ　https://www.writeblocked.org/resources/

#### 3. 510-511 MBR 署名

- マジックナンバー `55 AA`

### 保護 MBR

- 形式は MBR と似ているが、保護 MBR の目的は、このディスクが GPT を使用していることを BIOS システムに通知すること。
- ブートローダーレコードは全て 0 になっていることが多い
- パーティションテーブルは、パーティションタイプの部分が EE になっている点だけが重要。これは GPT 形式のディスクであることを表す。
- MBR 署名は MBR と同じ。

### GPT

#### プライマリ GPT ヘッダー

- GPT ヘッダーは、保護 MBR の末尾の次のバイトから始まる。
- GPT ヘッダーの領域は 512 バイトを占有するが、意味があるのは最初の 92 バイトのみ。

| バイト位置 | バイト長 | バイト値（例）                                  | フィールド名                     | 説明                                                                                                                                       |
| ---------- | -------- | ----------------------------------------------- | -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| 0 - 7      | 8        | 45 46 49 20 50 41 52 54                         | 署名                             | 固定                                                                                                                                       |
| 8 - 11     | 4        | 00 00 01 00                                     | リビジョン                       | 1.0                                                                                                                                        |
| 12 - 15    | 4        | 5C 00 00 00                                     | ヘッダーサイズ                   | 92 バイト                                                                                                                                  |
| 16 - 19    | 4        | 71 89 13 1C                                     | ヘッダーの CRC32                 |                                                                                                                                            |
| 20 - 23    | 4        | 00 00 00 00                                     | 予約済み                         |                                                                                                                                            |
| 24 - 31    | 8        | 01 00 00 00 00 00 00 00                         | 現在の LBA                       | セクター 1                                                                                                                                 |
| 32 - 39    | 8        | AF 32 CF 1D 00 00 00 00                         | バックアップ LBA                 |                                                                                                                                            |
| 40 - 47    | 8        | 22 00 00 00 00 00 00 00                         | 最初の使用可能な LBA             | ディスク上でパーティションを開始できる最初のアドレス                                                                                       |
| 48 - 55    | 8        | 8E 32 CF 1D 00 00 00 00                         | 最後に使用可能な LBA             | ディスク上のパーティションに書き込むことができる最後のアドレス。このアドレス以降のディスク領域は、パーティションで占有することはできない。 |
| 56 - 71    | 16       | 1D F1 B0 D6 43 BE 37 4E B1 E6 38 66 EC B1 73 89 | ディスク GUID                    | 他のディスクと区別する                                                                                                                     |
| 72 - 79    | 8        | 02 00 00 00 00 00 00 00                         | パーティションエントリアレイ LBA | パーティション エントリ アレイの開始                                                                                                       |
| 80 - 83    | 4        | 80 00 00 00                                     | パーティションエントリの数       | ディスク上のパーティション数                                                                                                               |
| 84 - 87    | 4        | 80 00 00 00                                     | 各パーティションエントリのサイズ | パーティションエントリ配列のサイズ                                                                                                         |
| 88 - 91    | 4        | 41 0D C0 22                                     | パーティション配列の CRC32       | パーティション エントリ アレイ全体の CRC32 チェックサム                                                                                    |

#### パーティションエントリ配列

- セクター 2 から始まる
- エントリの数は 128 個。各パーティションエントリは 128 バイトで構成される
- 存在しないパーティションの部分は 00 で埋まる。

| バイト位置 | バイト長 | バイト値（例）                                  | フィールド名              | 説明                                                              |
| ---------- | -------- | ----------------------------------------------- | ------------------------- | ----------------------------------------------------------------- |
| 0 - 15     | 16       | 28 73 2A C1 1F F8 D2 11 BA 4B 00 A0 C9 3E C9 3B | パーティションタイプ GUID | 混合エンディアン。GUID に変換するとパーティションタイプが分かる。 |
| 16 - 31    | 16       | 9E 43 0D 72 EC 12 54 44 8F B2 EE 17 8D F3 CD 3B | 一意のパーティション GUID | ディスク上のパーティションを区別                                  |
| 32 - 39    | 8        | 00 08 00 00 00 00 00 00                         | LBA の開始                |                                                                   |
| 40 - 47    | 8        | FF 27 03 00 00 00 00 00                         | LBA の終了                |                                                                   |
| 48 - 55    | 8        | 00 00 00 00 00 00 00 80                         | 属性                      | 起動可能、非表示、通常などのフラグ                                |
| 56 - 127   | 72       | 45 00 46 00 49 00 20 00 73 00 79 00 73 ...      | パーティション名          | UTF-16 エンコード文字列                                           |

- HxD アプリケーション上で GUID 部分を選択すると、右側のペインに GUID が表示されるので便利。

##### EFI システムパーティション (ESP)

EFI システムパーティション `C12A7328-F81F-11D2-BA4B-00A0C93EC93B` は、すべての GPT ディスク上にパーティションとして保存され、ブートプロセスにおいて非常に重要なコンポーネント。GPT では、ブートローダーは.efi 拡張子を持つ複数のファイルで構成され( OS に応じて bootmgr.efi、bootx64.efi など)、それらはすべてこの EFI システムパーティション (ESP) に保存される。EFI システムパーティションからブートローダーが見つかると、 ディスクのブート可能パーティションからオペレーティングシステムのカーネルが ロードされる。

UEFI のセキュアブート機能を有効にすると、ESP 内のブートローダー（.efi ファイル）のデジタル署名が検証され、改ざんされたファイルの実行ができなくなる。

#### バックアップ GPT ヘッダー

ディスクの最終セクターに配置。プライマリ GPT ヘッダーと同じ内容が含まれる。

#### バックアップパーティションエントリ配列

パーティションエントリ配列のバックアップコピー。バックアップ GPT ヘッダーの直前に配置される。

## FAT32

https://tryhackme.com/room/fat32analysis

### 1. 予約領域

| 分野                                       | セクター番号                   | オフセット（HEX） |
| ------------------------------------------ | ------------------------------ | ----------------- |
| ブートセクター（ボリュームブートレコード） | 0                              | 0                 |
| FSinfo セクター                            | 1                              | 200               |
| バックアップブートセクター                 | 6                              | C00               |
| 追加の予約セクター                         | セクター 7 から FAT の開始まで | E00               |

- 通常、セクターは 512 バイト
- セクター 2 から 5 は予約済み
- FAT1 の開始オフセットは、ブートセクターの `セクターあたりのバイト数 × 予約セクター数` になる。

#### ブートセクター

常にパーティションのセクター 0 から始まる。

| 分野                           | サブフィールド                   | サイズ（バイト） | オフセット（HEX） | 説明                                                 |
| ------------------------------ | -------------------------------- | ---------------- | ----------------- | ---------------------------------------------------- |
| ジャンプ命令                   |                                  | 3                | 00                | ブートコードの実行開始位置を示す。                   |
| OEM 名                         |                                  | 8                | 03                | ディスクをフォーマットした OEM 名。                  |
| BIOS パラメータブロック（BPB） | セクターあたりのバイト数         | 2                | 0B                | セクターサイズ。通常は 512 バイト。                  |
|                                | クラスターあたりのセクター数     | 1                | 0D                | 1 クラスタを構成するセクター数。                     |
|                                | 予約セクター数                   | 2                | 0E                | 予約されているセクター数数。                         |
|                                | FAT の数                         | 1                | 10                | FAT テーブルの数。通常は 2。                         |
|                                | ルートディレクトリエントリ最大数 | 2                | 11                | ルートディレクトリに格納可能な最大数。FAT32 では 0。 |
|                                | セクター合計（16bit）            | 2                | 13                | ボリューム上のセクター総数。FAT32 ではこの値は 0。   |
|                                | メディア記述子                   | 1                | 15                | メディアの種類。例: 0xF8 は固定ディスク。            |
|                                | FAT あたりのセクター数（16bit）  | 2                | 16                | FAT のサイズ（セクター単位）。                       |
|                                | トラックあたりのセクター数       | 2                | 18                | ハードディスクの構造に関連。                         |
|                                | ヘッド数                         | 2                | 1A                | ハードディスクのヘッド数。                           |
|                                | 隠しセクター                     | 4                | 1C                | パーティション開始までのセクター数。                 |
| セクター合計 32                |                                  | 4                | 20                | セクター数（32bit）。FAT32 ではこの値は 0 以外。     |
| 拡張 BPB                       | FAT あたりのセクター数（32bit）  | 4                | 24                | FAT に割り当てられるセクター数。                     |
|                                | フラグ                           | 2                | 28                | FAT のミラー設定。0 ならミラーリング有効。           |
|                                | バージョン                       | 4                | 2A                | FAT32 のバージョン（通常 V0.0）。                    |
|                                | クラスタールートディレクトリ     | 4                | 2E                | ルートディレクトリのクラスタ番号。                   |
|                                | FSInfo セクター                  | 2                | 32                | 空きクラスター情報の位置。                           |
|                                | バックアップブートセクタ         | 2                | 34                | バックアップのブートセクター位置。                   |
| ブートコード                   |                                  | 420              | 36                | BIOS の起動コード。                                  |
| ブートセクター署名             |                                  | 2                | 1DA               | ブートセクターの検証用署名。                         |

### 2. FAT 領域

FAT1（ファイルアロケーションテーブル）と FAT2（バックアップ）

- FAT2 は FAT1 の直後から始まる。
- FAT エントリは各 4 バイト。
- クラスターインデックス 0,1 は予約済みのため、実質的にはインデックス 2（3 番目のエントリ） から始まる。

#### FAT エントリ 4 バイトの一般的な意味

値はリトルエンディアンのため、バイナリエディタで逆順に見える。

| 値                        | 意味                                                                                                              |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------- |
| 00 00 00 00               | フリーのクラスター。                                                                                              |
| 00 00 00 02 - 0F FF FF F6 | 使用されたクラスター: チェーン内の次のクラスターは XX。（例：00 00 00 08 であれば、次のクラスターはクラスター 8） |
| 0F FF FF F7               | 不良クラスター。                                                                                                  |
| 0F FF FF F8 - 0F FF FF FF | ファイルの終わり (EOF)。                                                                                          |
| FF FF FF FF               | ファイルの終わり (EOF)。                                                                                          |

### 3. データエリア

- クラスタ 0，1 に対応する物理的なデータクラスタは存在しない。FAT 内だけの論理番号。
- ルートディレクトリはクラスタ２。つまり、データエリアの先頭。
- クラスタがディレクトリに対応する場合、クラスタの中には、ディレクトリ内のファイルの LFN、SFN が含まれる。
- クラスタがファイルに対応する場合、クラスタの中にはファイルのコンテンツが含まれる。

#### 長いファイル名（LFN）32 バイト

| オフセット | サイズ | 内容                        | 説明                         |
| ---------- | ------ | --------------------------- | ---------------------------- |
| 0x00       | 1      | シーケンス番号・フラグ      | 順番、最終・削除フラグを含む |
| 0x01       | 10     | ファイル名（最初の 5 文字） | UTF-16 で 5 文字分           |
| 0x0B       | 1      | 属性                        | 通常 0x0F（LFN 用）          |
| 0x0C       | 1      | タイプ                      | 予約済み、常に 0x00          |
| 0x0D       | 1      | チェックサム                | 短縮名の整合性確認用         |
| 0x0E       | 12     | ファイル名（次の 6 文字）   | UTF-16 で 6 文字分           |
| 0x1A       | 2      | 予約（FAT クラスタ）        | レガシー互換用               |
| 0x1C       | 4      | ファイル名（最後の 2 文字） | UTF-16 で 2 文字分           |

#### 短いファイル名（SFN）32 バイト

| オフセット | サイズ | フィールド名               | 説明                                       |
| ---------- | ------ | -------------------------- | ------------------------------------------ |
| 0x00       | 11     | ファイル名                 | 8.3 形式（名前 8 バイト＋拡張子 3 バイト） |
| 0x0B       | 1      | 属性                       | READ_ONLY, HIDDEN などの属性フラグ         |
| 0x0C       | 1      | 予約済み                   | 通常 0x00                                  |
| 0x0D       | 1      | 作成時刻（10 分の 1 秒）   | 作成時の 10 分の 1 秒単位の時間            |
| 0x0E       | 2      | 作成時間                   | 時・分・秒をビット分割して格納             |
| 0x10       | 2      | 作成日                     | 年・月・日をビット分割して格納             |
| 0x12       | 2      | 最終アクセス日             | 最後にアクセスした日付                     |
| 0x14       | 2      | 第一クラスターのハイワード | FAT32 の上位 16 ビット（開始クラスタ番号） |
| 0x16       | 2      | 最終更新日時               | 最後に変更された時間                       |
| 0x18       | 2      | 最終更新日                 | 最後に変更された日付                       |
| 0x1A       | 2      | 最初のクラスタの下位ワード | 開始クラスタ番号の下位 16 ビット           |
| 0x1C       | 4      | ファイルサイズ             | バイト単位のファイルサイズ（最大 4GiB-1）  |

## NFT

https://tryhackme.com/room/ntfsanalysis

### 構造

#### パーティションブートセクター（PBS）

- ブートストラップ コードへのジャンプ命令
- ファイル システム タイプ インジケーター (例: NTFS)
- MFT と MFT ミラーの場所
- セクター終了マーカー ( 0x55AA )

#### マスターファイルテーブル（MFT）

- 固定サイズのレコード (通常 1 KB) に分割される
- 各ファイルとディレクトリには MFT エントリが付与される
- タイムスタンプ、権限、データの場所などのファイル属性はメタデータとして保存される

#### $MFTMirr

MFT のミラー

#### システムファイル

- $MFT: マスターファイルテーブル
- $MFTMirr: MFT ミラー
- $LogFile: 一貫性を保つためのトランザクション ログ
- $Bitmap: 割り当てられたクラスターと空きクラスターを追跡する
- $Boot: ブートセクター情報を保存する
- $BadClus: 不良セクタを追跡する
- $UpCase: 大文字と小文字を区別しない比較のために大文字の文字マッピングを保存する

#### ファイルデータ領域

#### 代替データストリーム

### MFT

MFT レコードには次の情報が含まれる。

- ファイル名:ファイルの名前またはその中に含まれるディレクトリ。
- 標準情報: リンク数、タイムスタンプ、ファイル属性などの重要な情報が含まれる。
- 属性: MACB タイムスタンプなどのメタデータ、読み取り専用、非表示などの属性。
- ファイル データ: ファイルが MFT レコード内に収まるほど小さい場合は実際のデータが含まれる。それ以外の場合は、データが保存されているクラスターを指しる。
- ファイル インデックス:他のファイルまたはディレクトリを指すインデックス情報。
- セキュリティ情報:ファイルまたはディレクトリのセキュリティ権限を定義する ACL 。

```sh
# MFTファイルから情報抽出（MFTファイルはFTK Imagerでエクスポートできる）
MFTECmd.exe -f ..\Evidence\$MFT --csv ..\Evidence --csvf ..\Evidence\MFT_record.csv
```

### ジャーナリング

#### $LogFile

$LogFile は NTFS の特別なメタデータファイルで、ジャーナルとして機能する。ファイルの作成、削除、変更などのメタデータの変更をディスクにコミットする前に記録する。

ルートディレクトリにある。

#### USN ジャーナル （$USNJrnl）

USN ジャーナル（Update Sequence Number Journal の略）は、NTFS の機能の一つで、ファイル、ディレクトリ、そしてそれらの属性に加えられた変更を記録する。

ルート ディレクトリ内の $Extend ディレクトリにある。

FTK Imager で（$USNJrnl）を開くと3つのコンポーネントが表示され、そのうちの `$J`が実際の変更記録を保存する。また、FTK Imagerd で`$J` をエクスポートし、下記コマンドで抽出できる。

```sh
MFTECmd.exe -f ..\Evidence\$J --csv ..\Evidence --csvf USNJrnl.csv
```

### インデックス割り当て属性 ($I30)

主にディレクトリのインデックスエントリを保存するために使用され、ディレクトリ内のファイルとサブディレクトリに関するメタデータが含まれている。このメタデータには、ファイル名、タイムスタンプ、その他のファイルの詳細（削除または変更されたファイルも含む）が含まれる。

そのディレクトリの中に入っている（かもしれない）。

これもエクスポート後に情報抽出できる。

```sh
MFTECmd.exe -f ..\Evidence\$I30 --csv ..\Evidence\ --csvf i30.csv
```
