# ActiveDirectory復旧

https://tryhackme.com/room/recoveringactivedirectory

## 初動

1. 侵入されたADサーバーのバックアップは、組み込みユーティリティ「Windows Serverバックアップ」を使用して作成する。バックアップは `wbadmin.msc` からアクセスできる。アナリストは、このバックアップを後ほどマルウェアや脅威の詳細な分析に使用する。

1. Windows Server の信頼できるバックアップを復元する
。この復元操作により、信頼できるバックアップの作成後にドメインに追加されたADオブジェクト（ユーザー、コンピューターなど）などの一部のデータが失われる。

1. ネットワークを分離し、セカンダリ ドメイン コントローラーをアクティブ化して、ユーザーに中断のないサービスを提供する。

1. 復元されたADサーバーからのトラフィックの強化された監視とフィルタリングを有効にして、ネットワーク レベルでの攻撃パターンを識別する。

1. (可能な場合) 回復プロセスが完了するまで、新しいユーザー アカウント、GPO などの作成と変更を制限する

## 攻撃パターンの特定

- EventViewer
- [BloodHound](https://github.com/SpecterOps/BloodHound-Legacy)
- [PowerView](https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon)

```ps
Import-Module .\pw.ps1
Get-NetDomainController
Get-NetComputer | select name
```

## 感染ベクターの特定

### ユーザー作成・変更の検出

```ps
Get-ADUser -Filter {((Enabled -eq $True) -and (Created -gt "Monday, April 10, 2023 00:00:00 AM"))} -Property Created, LastLogonDate | select SamAccountName, Name, Created | Sort-Object Created
```

### ドメインに参加したコンピュータの検出

```ps
Get-ADComputer -filter * -properties whencreated | Select Name,@{n="Owner";e={(Get-acl "ad:\$($_.distinguishedname)").owner}},whencreated 
```

### グループメンバーシップの変更

- ID 4756 : ユニバーサル セキュリティ グループにメンバーが追加されました。
- ID 4757 : ユニバーサル セキュリティ グループからメンバーが削除されました。
- ID 4728 : グローバル セキュリティ グループにメンバーが追加されました。
- ID 4729 : グローバル セキュリティ グループからメンバーが削除されました。

### グループポリシー変更

- ID 4719 : 有効なユーザーまたは無効なユーザーがシステム監査ポリシーを更新した（または、しようとした）
- ID 4739 : ドメインポリシーの変更

## テイクバック

1. Tier 0アカウントのパスワードをリセットする

1. 侵害された可能性のある（疑わしい）アカウントを探し、権限の昇格を避けるためにパスワードをリセットする

1. Kerberosサービス アカウントのパスワードを変更し、攻撃者が使用できないようにする

1. 管理者権限を持つアカウントのパスワードをリセットする

1. `Reset-ComputerMachinePassword` PowerShell コマンドを使用して、ドメイン上のコンピューター オブジェクトのリセット操作を実行する

1. シルバーチケットの悪用を防ぐため、ドメインコントローラーマシンのパスワードをリセットする

1. 侵害されたドメインコントローラーのバックアップとして書き込み可能なドメインコントローラー（DC）を設定している場合は、それを復元することで混乱を回避できる

1. 悪意のあるスクリプトを識別するために、対象となるドメイン コントローラー サーバーでマルウェア分析を実行する

1. 攻撃者が永続的なアクセスのために、スケジュールされたタスクやスタートアップアプリケーションを追加していないことを確認する

1. イベント ログ、アクセス制御リスト (ACL)、およびグループ ポリシーをチェックして、変更の可能性がないか確認する

1. 受信トラフィックと送信トラフィックのトラフィック フィルタリングを有効にして、ネットワーク レベルで侵害の兆候 ( IOC ) を識別する

## よくある設定ミス

### BIOSの起動順序

### ADサーバー管理者グループのメンバー

- Domain Usersグループのすべてのメンバーは、デフォルトでAD内の任意のワークステーションにログインできる
- そのため、特権アクセスやドメインコントローラーを持つコンピューターにローカルログインできるユーザーを制限するための予防措置を講じる必要がある
- これは、「ローカルログオンを許可する」ポリシーを使用することで実現できる

```
Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies > User Rights Assignment をダブルクリックして、 DCAllow log on locally
```

### 弱いパスワード

### DCSync攻撃の防止

DCSync攻撃を検知した場合、侵害されたアカウントを直ちに無効化することで、攻撃者による権限昇格を防ぎ、グループポリシーオブジェクトを介してネットワークに他の変更を加える能力を制限することができる。

### ワークステーション上のスクリプトとアプリケーションの権限

多くのマルウェアは、コマンドプロンプト、PowerShell 、バッチファイルを使用して実行される。スクリプトとアプリケーションに対する制限ポリシーは、 ADサーバーに対する多くのサイバー攻撃から保護できる。

### ネットワーク時刻同期を構成する

ネットワークデバイスとアプリケーションは、セキュリティ情報とイベント管理のために同じタイムゾーンを使用できる必要がある。これにより、脅威アクターの特定と攻撃パターンの相関関係の把握が容易になる。

## 回復後のアクション

