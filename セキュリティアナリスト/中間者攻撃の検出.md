# 中間者攻撃の検出

https://tryhackme.com/room/mitmdetection

## ARPスプーフィング

- 目に見えるリクエストがないにもかかわらず多数の応答が返っている
- 疑わしいMACアドレスから同じIPアドレスが繰り返しアドバタイズされる
- 疑わしいホストは、特に複数の宛先に対して、多数の不要な（Gratuitous）ARP応答を送信

```sh
# リクエスト
arp.opcode == 1

# 応答
arp.opcode == 2

# Gratuitousパケット
arp.isgratuitous

# ゲートウェイに関連付けられた応答
arp.opcode == 2 && arp.src.proto_ipv4 == 192.168.10.1
arp.opcode ==2 && _ws.col.info contains "192.168.10.1 is at"

# 重複したIP-MACマッピング
arp.duplicate-address-detected || arp.duplicate-address-frame
```

## DNSスプーフィング

- 同じクエリに対する複数のDNS応答
- 予期しないソースからのDNS応答
- 不審なほど短いTTL (Time-To-Live) 値
- 未承諾DNS応答(対応するDNS要求がない状態でDNS応答)

```sh
# 正当なトラフィック
dns.flags.response == 1 && ip.src == 8.8.8.8

# 不当かもしれないトラフィック
dns.flags.response == 1 && ip.src != 8.8.8.8

# ドメイン指定
dns && dns.qry.name == "corp-login.acme-corp.local"
```

## SSLストリッピング

- 最初の要求と応答: ユーザーの最初の要求はHTTPS(ポート 443) 向けだが、後続のパケットはHTTP同じドメインの暗号化されていない (ポート 80) にすぐに切り替わる。
- リダイレクト/リンク書き換え: HTTPS 要求をHTTPリソースに永続的に送信しているリダイレクト ( HTTPステータス コード 301、302)を監視する。
- 証明書エラー: 攻撃者は通常これを隠そうとするが、攻撃者がより直接的なプロキシ手法を使用すると、初期のTLS/SSL ハンドシェイクが失敗したり、自己署名証明書が表示されたりする可能性がある。

```sh
tls || ssl

# サイトが通常、通信に TLS を使用していることを確認
tls.handshake.type == 1 && tls.handshake.extensions_server_name == "corp-login.acme-corp.local"

# TLS通信をやめている
http && ip.src == 192.168.10.10 && ip.dst == 192.168.10.55
```
