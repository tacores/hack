# マルウェア分析

https://tryhackme.com/room/intromalwareanalysis

https://tryhackme.com/room/staticanalysis1

## 基本

- マルウェア分析は、クリーンで分離された、専用の環境で行う
- 分析が終わったら、スナップショットで元のクリーンな状態に戻す

### マルウェア分析 VM

#### FLARE VM

https://github.com/mandiant/flare-vm

- Windows ベース
- VM 上に Windows をインストールした上にインストールする感じ

#### REMnux

https://docs.remnux.org/

- Linux ディストリビューション
- Windows マルウェアの動的分析はできない

### 基本のコマンド

```shell
file <filename>
strings <filename>
md5sum <filename>
```

### Floss ツール

https://github.com/mandiant/flare-floss/releases

- strings コマンドと似た使い方で、難読化された文字列を検出できる

```shell
floss --no-static-strings <path to binary>
```

### IDA free

https://hex-rays.com/ida-free

### オンラインサービス

- [Virustotal](https://www.virustotal.com/gui/home/upload)  
  ファイルをアップロードすることも、ハッシュを検索することもできる

### x86 アーキテクチャ

https://tryhackme.com/room/x8664arch

### x86 アセンブリ

https://tryhackme.com/room/x86assemblycrashcourse

## PE ファイルヘッダー

### CLI

```shell
pecheck <filename>
```

### GUI

```shell
pe-tree <filename>
```

#### pestudio

https://www.winitor.com/download

## 動的解析

### オープンソースサンドボックス

https://github.com/cuckoosandbox/cuckoo

https://github.com/kevoreilly/CAPEv2

### オンラインサービス

https://cuckoo.cert.ee/

https://any.run/

https://analyze.intezer.com/

https://hybrid-analysis.com/

### capa

https://github.com/mandiant/capa

```shell
capa mal.exe

capa -vv mal.exe > out.txt
```

### デバッガーhttps://github.com/kevoreilly/CAPEv2

https://x64dbg.com/

## ハッシュ

### imphash

https://cloud.google.com/blog/topics/threat-intelligence/tracking-malware-import-hashing/?hl=en

マルウェアサンプルがインポートする関数呼び出し/ライブラリと、それらのライブラリがサンプル内に存在する順序のハッシュ。PEstudio では imphash が表示される。

### ファジーハッシュ/SSDEEP

https://ssdeep-project.github.io/ssdeep/index.html

```shell
# ディレクトリ内のファイルの類似性を比較
ssdeep -l -r -d <dirname>
```

## マルウェアが使用する一般的な API（Windows）

https://tryhackme.com/room/advancedstaticanalysis

https://malapi.io/

## ドキュメント系

https://tryhackme.com/room/maldoc

### Office

#### oletools

https://github.com/decalage2/oletools

```shell
# ドキュメントの基本情報
oleid sample.doc

# ストリームに関する基本情報
olemeta sample.doc

# ストリームオブジェクトの作成、更新時刻
oletimes sample.doc

# セクターに関する詳細
olemap sample.doc

# VBAマクロの解析
olevba sample.doc

# マクロの有無をチェックできる
oledump sample.doc
```

oledump.py

https://github.com/DidierStevens/DidierStevensSuite

```sh
ubuntu@ip-10-48-180-106:~/Desktop/maldocs$ oledump.py ./attacker1.doc
  1:       114 '\x01CompObj'
  2:      4096 '\x05DocumentSummaryInformation'
  3:      4096 '\x05SummaryInformation'
  4:     13859 '1Table'
  5:     33430 'Data'
  6:       365 'Macros/PROJECT'
  7:        41 'Macros/PROJECTwm'
  8: M    9852 'Macros/VBA/ThisDocument'
  9:      5460 'Macros/VBA/_VBA_PROJECT'
 10:       513 'Macros/VBA/dir'
 11:       306 'MsoDataStore/ÇYÕXGNÎÕÃUKWÛÎIS2BKÍÐÐ==/Item'
 12:       341 'MsoDataStore/ÇYÕXGNÎÕÃUKWÛÎIS2BKÍÐÐ==/Properties'
 13:      4096 'WordDocument'
```

```sh
# -i で extra info を表示
oledump.py -i ./attacker2.doc 

# バイナリエディタのような形式で表示
oledump.py -s 11 ./attacker1.doc

# 文字列として表示
oledump.py -s 11 -S ./attacker1.doc
```

#### ViperMonkey

https://github.com/decalage2/ViperMonkey

Microsoft Office ドキュメント内の悪意のあるマクロの動作を分析およびエミュレートするツール

```sh
git clone https://github.com/decalage2/ViperMonkey.git
chmod +x ./ViperMonkey/docker/dockermonkey.sh
```

```sh
docker/dockermonkey.sh sample.doc
```

```shell
vmonkey.py sample.doc
```

#### scdbg

Windowsシェルコード解析アプリケーション

https://sandsprite.com/blogs/index.php?uid=7&pid=152

```sh
wget http://sandsprite.com/CodeStuff/scdbg.zip --no-check-certificate
```

/s -1 でステップ数無制限になる。付けないと途中までしか解析されない危険がある。Ctrl+Cで強制終了する。

```sh
$ wine ~/tools/scdbg/scdbg.exe /f ./download.dat /s -1
Loaded 31e bytes from file ./download.dat
Initialization Complete..
Max Steps: -1
Using base offset: 0x401000

4010a2  LoadLibraryA(wininet)
4010b0  InternetOpenA()
4010cc  InternetConnectA(server: 176.103.56.89, port: 8080, )
4010e4  HttpOpenRequestA(path: /SjMR, )
4010f8  HttpSendRequestA(User-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; .NET CLR 2.0.5
0727)
, )
40111a  GetDesktopWindow()
401129  InternetErrorDlg(11223344, 4893, 40111a, 7, 0)
4012de  VirtualAlloc(base=0 , sz=400000) = 600000
4012f9  InternetReadFile(4893, buf: 600000, size: 2000)
```

### PDF

https://pypi.org/project/pdfid/

https://github.com/smalot/pdfparser

https://github.com/jesparza/peepdf

```shell
# interactive
peepdf -i <pdf-file>

> help
> object 6
> extract js
```

### js

#### Box-js

https://github.com/CapacitorSet/box-js

サンドボックス環境で JavaScript コードの分析と実行を行うツール。難読化された js を素早く分析できる。

```shell
box-js embedded-code.js
```

## 動的解析

### regcool (regshot)

https://kurtzimmermann.com/downrc_en.html

レジストリの新旧ショットを比較するツール

### procmon

Systeinternals のツール
