# ファイルカービング

https://tryhackme.com/room/filecarving

ファイルカービングとは、ファイルシステムのメタデータに依存せずに生データからファイルを抽出するプロセス。ストレージメディアをスキャンしてファイルシグネチャ（マジックバイト）を検出し、そのパターンに基づいてファイルを再構築する。

## 基礎

### 工程

1. 署名のスキャン:ツールは生データ内の既知のファイル ヘッダーを検索する。
2. ファイル境界の決定:ヘッダーとフッターを使用して、ファイルの開始位置と終了位置を定義する。
3. ファイルの再構築:識別された境界間のデータを抽出する。

### マジックバイト

https://en.wikipedia.org/wiki/List_of_file_signatures

ファイルを認識するためによく使われるマジックバイト

| ファイル形式 | ヘッダー                                               | フッター / 終了マーカー                   | 備考                         |
| ------------ | ------------------------------------------------------ | ----------------------------------------- | ---------------------------- |
| JPEG         | FF D8 FF E0（一般に FF D8 FF）                         | FF D9                                     | よく使われる画像形式         |
| PNG          | 89 50 4E 47 0D 0A 1A 0A                                | 49 45 4E 44 AE 42 60 82                   | チャンクで開始と終了を識別   |
| PDF          | %PDF（25 50 44 46）                                    | %%EOF（25 25 45 4F 46）                   | 電子文書フォーマット         |
| DOCX         | 50 4B 03 04（ZIP のシグネチャ）                        | 50 4B 05 06（ZIP の中央ディレクトリ終端） | XML を含む ZIP 形式の文書    |
| GIF          | GIF89a: 47 49 46 38 39 61<br>GIF87a: 47 49 46 38 37 61 | 00 3B                                     | セミコロンで終了する画像形式 |
| ZIP          | 50 4B 03 04                                            | 50 4B 05 06                               | 汎用的な圧縮アーカイブ形式   |

ファイル形式によって最後にマジックバイトがある場合もある。

PNG の最後は「49454E44AE426082」

### ツール

| ツール名      | 無料      | 備考                                                               |
| ------------- | --------- | ------------------------------------------------------------------ |
| **hexeditor** | ✅ はい   | 多くのバージョンがあり、Linux の `hexedit` などは完全に無料。      |
| **Binwalk**   | ✅ はい   | オープンソース。ファームウェア解析などに広く使われる。             |
| **Scalpel**   | ✅ はい   | フリーでオープンソース。ファイルカービングツール。                 |
| **Foremost**  | ✅ はい   | オープンソースのファイル復元ツール。                               |
| **PhotoRec**  | ✅ はい   | オープンソースで高性能な復元ツール。                               |
| **EnCase**    | ❌ いいえ | 商用ソフト。高機能だが有償ライセンスが必要。法執行機関でよく使用。 |

## 手動

```sh
# Okteta 等で調べ、オフセットとサイズが分かっている場合
dd if=Challenge1_Manual_Carve_usb.img of=Image.png bs=1 skip=134483968 count=463
```

```sh
# リスト表示
binwalk Challenge2_slack_space.img

# 抽出を実行
binwalk -e Challenge2_slack_space.img
```

### 課題

#### 断片化されたファイル

断片化されたデータは、完全なファイルとは異なり、連続したブロックに存在しないため、アナリストは以下の作業を行う必要がある。

1. フラグメントの特定：ストレージ メディア全体に散らばっている個々のファイル部分を正確に特定。
2. ファイルの再構築：ファイル形式とエンコードに関する詳細な知識を活用して、フラグメントを正しい順序で再構築。
3. 欠落データの処理：ヒューリスティックを使用してファイル フラグメント内のギャップをナビゲートするか、データが回復できない場合に部分的な回復を認識。

#### 時間のかかる性質

ファイルカービングの手作業は本質的に時間がかかる。アナリストは次のような課題に直面している。

1. 大量のデータ：現代のストレージ デバイスにはテラバイト単位のデータが保存されるため、選別プロセスが困難になる。
2. 複雑なエンコード：暗号化または難読化されたファイルはプロセスをさらに遅くし、復号化キーまたはリバース エンジニアリングが必要になる。
3. 独自の形式：特定のファイルタイプに関するドキュメントが不足すると、複雑なタスクが調査のパズルに変わってしまう可能性がある。

#### 技術的な障壁

断片化と時間の要求に加えて、手作業による彫刻には、特定の技術的障壁を克服することが必要になることがよくある。

1. 破損と損傷：破損したファイルヘッダーまたはデータブロックを識別して修復するには専門知識が必要。
2. 誤検知：有効なフラグメントを無関係なデータから区別するのは難しい場合があり、慎重な検証が必要。
3. ツールの制限：標準的なフォレンジック ツールではニッチなファイル形式に対応できない場合があり、カスタムソリューションが必要。

## 自動ツール

### Foremost

```
/etc/foremost.conf

# 独自仕様の形式やあまり一般的ではない形式向けに、専用のヘッダーを定義できる
/etc/custom_foremost.conf
```

```sh
foremost -i Challenge3_deleted_disk.img -o Challenge3_files -c /etc/custom_foremost.conf

# タイプ指定
foremost -t pdf,jpg,png -i Challenge3_deleted_disk.img -o Challenge3_files -c /etc/custom_foremost.conf
```

### Scalpel

Foremost から派生した強力なオープンソースカービングユーティリティ

```
/etc/scalpel/scalpel.conf
```

```sh
scalpel Challenge3_deleted_disk.img -o ScalpelOutput -c /etc/scalpel/scalpel.conf
```
